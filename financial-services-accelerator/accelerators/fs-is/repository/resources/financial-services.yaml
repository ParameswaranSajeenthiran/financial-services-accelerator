components:
  policy-definitions:

    schemaValidationPolicy: &schemaValidationPolicy
      name: "Schema Validation Policy"
      type: "filter-policy"
      description: "Validate payload against JSON schema."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ConsentSchemaValidationFilterPolicy"
      parameters:
        json_schema_url: "https://gist.githubusercontent.com/Ashi1993/108436ac035b06e2e35604b66791f656/raw/4bd9d25fda6b2e9f634fb5ec882cca91c46fac9b/account-json-schema.json"

    clientIdValidationPolicy: &clientIdValidationPolicy
      name: "ClientId Validation Policy"
      type: "filter-policy"
      description: "Validate whether the client id is present in the request."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.ClientIdValidationFilterPolicy"

    futureDateValidationPolicy: &futureDateValidationPolicy
      name: "FutureDateValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the given dates are future dates."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.common.filter.policy.FutureDateValidationFilterPolicy"
      parameters:
        applicable_params:
          - "Data.ExpirationDateTime"

    callExternalAPI: &callExternalAPI
      name: "CallExternalAPI Policy"
      type: "filter-policy"
      description: "Invoke an external service."
      class: "org.wso2.financial.services.accelerator.common.policy.filter.common.ExternalValidationFilterPolicy"
      parameters:
        # Only supports http
        endpoint: "http://localhost:9766/api/fs/consent/manage/external"
        service_type: "consent"
        security:
          type: "basic-auth" # Change to "basic-auth" if needed
          username: ""
          password: ""

    jwtSignatureValidationPolicy: &jwtSignatureValidationPolicy
      name: "jwtSignatureValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate JWT signature."
      class: "org.wso2.financial.services.accelerator.common.policy.filter.common.JWTSignatureValidationFilterPolicy"
      parameters:
        # Signature validation is done using the public key of the cert with given alias
        type: "public-key"
        key-alias: "wso2carbon"
        # If the signature validation should be done using JWKS Url then uncomment below
        #type: "jwks-uri"
        #jwks_url: ""

    consentExpiryValidationPolicy: &consentExpiryValidationPolicy
      name: "consentExpiryValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the consent is expired."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.ConsentExpiryValidationFilterPolicy"
      parameters:
        expiry_date_param: "Data.ExpirationDateTime"

    consentStatusValidationPolicy: &consentStatusValidationPolicy
      name: "consentStatusValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the consent is in the applicable status."
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.ConsentStatusValidationFilterPolicy"
      parameters:
        applicable_status: "Authorised"

    clientIdMatchingValidationPolicy: &clientIdMatchingValidationPolicy
      name: "clientIdMatchingValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the client id of the submission request is matching with the client id associated with the consent"
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.ClientIdMatchingValidationFilterPolicy"

    userIdMatchingValidationPolicy: &userIdMatchingValidationPolicy
      name: "userIdMatchingValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the user id of the submission request is matching with the user id associated with the consent"
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.UserIdMatchingValidationFilterPolicy"

    accountIdMatchingValidationPolicy: &accountIdMatchingValidationPolicy
      name: "AccountIdMatchingValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the requested account id is bound to the the consent"
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.AccountIdMatchingValidationFilterPolicy"

    accountResourcePermissionMappingValidationPolicy: &accountResourcePermissionMappingValidationPolicy
      name: "accountResourcePermissionMappingValidationPolicy Policy"
      type: "filter-policy"
      description: "Validate whether the consent has the required permission to access the requested resource"
      class: "org.wso2.financial.services.accelerator.consent.mgt.extensions.validate.filter.policy.AccountPermissionMappingValidationFilterPolicy"
      parameters:
        path_to_permissions: "Data.Permissions"
        resource_permission_mappings:
          # Add resource paths (only support regex) and the mapped permission values seprated from pipeline
          - "/accounts|/accounts/[^/?]*": "ReadAccountsBasic|ReadAccountsDetail"
          - "/balances|/accounts/[^/?]*/balances": "ReadBalances"
          - "/transactions|/accounts/[^/?]*/transactions|/accounts/[^/?]*/statements/[^/?]*/transactions": "ReadTransactionsBasic|ReadTransactionsCredit|ReadTransactionsDebits|ReadTransactionsDetail"
          - "/beneficiaries|/accounts/[^/?]*/beneficiaries": "ReadBeneficiariesBasic|ReadBeneficiariesDetail"
          - "/direct-debits|/accounts/[^/?]*/direct-debits": "ReadDirectDebits"
          - "/offers|/accounts/[^/?]*/offers": "ReadOffers"
          - "/party": "ReadPartyPSU"
          - "/accounts/[^/?]*/parties|/accounts/[^/?]*/party": "ReadParty"
          - "/products|/accounts/[^/?]*/product": "ReadProducts"
          - "/scheduled-payments|/accounts/[^/?]*/scheduled-payments": "ReadScheduledPaymentsBasic|ReadScheduledPaymentsDetail"
          - "/standing-orders|/accounts/[^/?]*/standing-orders": "ReadStandingOrdersBasic|ReadStandingOrdersDetail"
          - "/statements|/accounts/[^/?]*/statements|/accounts/[^/?]*/statements/[^/?]*": "ReadStatementsBasic|ReadStatementsDetail"
          - "/accounts/[^/?]*/statements/[^/?]*/file": "ReadStatementsDetail"

apis:
  - name: "TokenAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/token:
        post:
          request-flow:
            policies:
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "AuthorizeAPI"
    version: "1.0"
    policies: []
    paths:
      /oauth2/authorize:
        get:
          request-flow:
            policies:

  - name: "AccountsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/account-access-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/account-access-consents/{ConsentId}:
        get:
          request-flow:
            policies:
          execution-flow:
            policies:
          response-flow:
            policies:
        delete:
          request-flow:
            policies:
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/validate/accounts:
        post:
          request-flow:
            policies:
              - *jwtSignatureValidationPolicy
              - *clientIdValidationPolicy
              - *consentExpiryValidationPolicy
              - *consentStatusValidationPolicy
              - *clientIdMatchingValidationPolicy
              - *userIdMatchingValidationPolicy
              - *accountIdMatchingValidationPolicy
              - *accountResourcePermissionMappingValidationPolicy
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "PaymentsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/domestic-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/domestic-standing-order-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/file-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-scheduled-payment-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.RequestedExecutionDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/international-standing-order-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.Initiation.FirstPaymentDateTime"
                    - "Data.Initiation.RecurringPaymentDateTime"
                    - "Data.Initiation.FinalPaymentDateTime"
                    - "Data.Authorisation.CompletionDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/validate/payments:
        post:
          request-flow:
            policies:
              - *jwtSignatureValidationPolicy
              - *clientIdValidationPolicy
              - *consentExpiryValidationPolicy
              - *consentStatusValidationPolicy
              - *clientIdMatchingValidationPolicy
              - *userIdMatchingValidationPolicy
          execution-flow:
            policies:
          response-flow:
            policies:

  - name: "ConfirmationOfFundsAPI"
    version: "1.0"
    policies: [ ]
    paths:
      /api/fs/consent/manage/funds-confirmation-consents:
        post:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - <<: *schemaValidationPolicy
                parameters:
                  json_schema_url: ""
              - <<: *futureDateValidationPolicy
                parameters:
                  applicable_params:
                    - "Data.ExpirationDateTime"
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/manage/funds-confirmation-consents/{ConsentId}:
        get:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
        delete:
          request-flow:
            policies:
              - *clientIdValidationPolicy
              - *callExternalAPI
          execution-flow:
            policies:
          response-flow:
            policies:
      /api/fs/consent/validate/fundsconfirmation:
        post:
          request-flow:
            policies:
              - *jwtSignatureValidationPolicy
              - *clientIdValidationPolicy
              - *consentExpiryValidationPolicy
              - *consentStatusValidationPolicy
              - *clientIdMatchingValidationPolicy
              - *userIdMatchingValidationPolicy
          execution-flow:
            policies:
          response-flow:
            policies:

# Global Policies (Applied to all APIs)
global-policies:
